<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaussian Distribution</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <style>
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 10px;
            height: 100vh;
        }
        .quadrant {
            border: 1px solid #ccc;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="quadrant">
            <h1>Control Estadístico del Proeceso</h1>
            <input type="text" id="dataLabel" placeholder="Enter data label">
            <br>
            <textarea id="dataInput" rows="10" cols="30" placeholder="Enter data values, one per line"></textarea>
            <br>
            <label for="usl">Especificación Superior:</label>
            <input type="number" id="usl" placeholder="Upper Specification Limit">
            <br>
            <label for="lsl">Especificación Inferior:</label>
            <input type="number" id="lsl" placeholder="Lower Specification Limit">
            <br>
            <button onclick="generateGauss()">Generate Gaussian Distribution</button>
            <button onclick="resetForm()">Reset</button>
            <button onclick="downloadPDF()">Download PDF</button>
        </div>
        <div class="quadrant">
            <h2>Results</h2>
            <p>Mean: <span id="mean"></span></p>
            <p>Standard Deviation: <span id="stddev"></span></p>
            <p>Range: <span id="range"></span></p>
            <p>Mode: <span id="mode"></span></p>
            <p>Skewness: <span id="skewness"></span></p>
            <p>Kurtosis: <span id="kurtosis"></span></p>
            <p>Cp: <span id="cp"></span></p>
            <p>Cpk: <span id="cpk"></span></p>
            <p>DPMO: <span id="dpmo"></span></p>
            <p>Yield: <span id="yield"></span></p>
            <h3>Control Limits</h3>
            <p>1 Std Dev: <span id="control_1_stddev"></span></p>
            <p>2 Std Dev: <span id="control_2_stddev"></span></p>
            <p>3 Std Dev: <span id="control_3_stddev"></span></p>
        </div>
        <div class="quadrant">
            <canvas id="controlChart" width="400" height="200"></canvas>
        </div>
        <div class="quadrant">
            <canvas id="histogramChart" width="400" height="200"></canvas>
        </div>
    </div>

    <script>
        let histogramChartInstance = null;
        let controlChartInstance = null;

        function generateGauss() {
            const dataLabel = document.getElementById('dataLabel').value;
            const dataInput = document.getElementById('dataInput').value;
            const values = dataInput.split('\n').map(Number).filter(val => !isNaN(val));
            const usl = document.getElementById('usl').value;
            const lsl = document.getElementById('lsl').value;

            console.log('Sending data:', { values: values, usl: usl ? parseFloat(usl) : null, lsl: lsl ? parseFloat(lsl) : null });
            
            fetch('/generate_gauss', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ values: values, usl: usl ? parseFloat(usl) : null, lsl: lsl ? parseFloat(lsl) : null })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Received data:', data);
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                document.getElementById('mean').innerText = data.mean;
                document.getElementById('stddev').innerText = data.stddev;
                document.getElementById('range').innerText = data.range;
                document.getElementById('mode').innerText = data.mode;
                document.getElementById('skewness').innerText = data.skewness;
                document.getElementById('kurtosis').innerText = data.kurtosis;
                document.getElementById('cp').innerText = data.cp !== null ? data.cp : 'N/A';
                document.getElementById('cpk').innerText = data.cpk !== null ? data.cpk : 'N/A';
                document.getElementById('dpmo').innerText = data.dpmo !== null ? data.dpmo : 'N/A';
                document.getElementById('yield').innerText = data.yield !== null ? data.yield.toFixed(2) + '%' : 'N/A';
                document.getElementById('control_1_stddev').innerText = `(${data.control_limits['1_stddev'][0]}, ${data.control_limits['1_stddev'][1]})`;
                document.getElementById('control_2_stddev').innerText = `(${data.control_limits['2_stddev'][0]}, ${data.control_limits['2_stddev'][1]})`;
                document.getElementById('control_3_stddev').innerText = `(${data.control_limits['3_stddev'][0]}, ${data.control_limits['3_stddev'][1]})`;
                drawHistogramChart(values, dataLabel);
                drawControlChart(values, data.mean, data.stddev, dataLabel);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while generating the Gaussian distribution. Please check the console for more details.');
            });
        }

        function drawHistogramChart(values, dataLabel) {
            const ctx = document.getElementById('histogramChart').getContext('2d');
            if (histogramChartInstance) {
                histogramChartInstance.destroy();
            }
            const bins = Math.ceil(Math.sqrt(values.length));
            const counts = new Array(bins).fill(0);
            const min = Math.min(...values);
            const max = Math.max(...values);
            const binWidth = (max - min) / bins;

            values.forEach(value => {
                const binIndex = Math.floor((value - min) / binWidth);
                counts[binIndex]++;
            });

            const labels = Array.from({ length: bins }, (_, i) => (min + i * binWidth).toFixed(2));

            histogramChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${dataLabel} - Histogram`,
                        data: counts,
                        backgroundColor: 'blue'
                    }]
                },
                options: {
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Value'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Frequency'
                            }
                        }
                    }
                }
            });
        }

        function drawControlChart(values, mean, stddev, dataLabel) {
            const ctx = document.getElementById('controlChart').getContext('2d');
            if (controlChartInstance) {
                controlChartInstance.destroy();
            }
            const labels = values.map((_, index) => index + 1);
            const ucl = mean + stddev;
            const lcl = mean - stddev;

            controlChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: `${dataLabel} - Values`,
                            data: values,
                            borderColor: 'blue',
                            fill: false
                        },
                        {
                            label: 'Mean',
                            data: new Array(values.length).fill(mean),
                            borderColor: 'green',
                            borderDash: [5, 5],
                            fill: false
                        },
                        {
                            label: 'UCL (Upper Control Limit)',
                            data: new Array(values.length).fill(ucl),
                            borderColor: 'red',
                            borderDash: [5, 5],
                            fill: false
                        },
                        {
                            label: 'LCL (Lower Control Limit)',
                            data: new Array(values.length).fill(lcl),
                            borderColor: 'red',
                            borderDash: [5, 5],
                            fill: false
                        }
                    ]
                },
                options: {
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Sample'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Value'
                            }
                        }
                    }
                }
            });
        }

        function resetForm() {
            document.getElementById('dataLabel').value = '';
            document.getElementById('dataInput').value = '';
            document.getElementById('usl').value = '';
            document.getElementById('lsl').value = '';
            document.getElementById('mean').innerText = '';
            document.getElementById('stddev').innerText = '';
            document.getElementById('range').innerText = '';
            document.getElementById('mode').innerText = '';
            document.getElementById('skewness').innerText = '';
            document.getElementById('kurtosis').innerText = '';
            document.getElementById('cp').innerText = '';
            document.getElementById('cpk').innerText = '';
            document.getElementById('dpmo').innerText = '';
            document.getElementById('yield').innerText = '';
            document.getElementById('control_1_stddev').innerText = '';
            document.getElementById('control_2_stddev').innerText = '';
            document.getElementById('control_3_stddev').innerText = '';
            if (histogramChartInstance) {
                histogramChartInstance.destroy();
                histogramChartInstance = null;
            }
            if (controlChartInstance) {
                controlChartInstance.destroy();
                controlChartInstance = null;
            }
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.text('Gaussian Distribution Generator', 10, 10);
            doc.text('Mean: ' + document.getElementById('mean').innerText, 10, 20);
            doc.text('Standard Deviation: ' + document.getElementById('stddev').innerText, 10, 30);
            doc.text('Range: ' + document.getElementById('range').innerText, 10, 40);
            doc.text('Mode: ' + document.getElementById('mode').innerText, 10, 50);
            doc.text('Skewness: ' + document.getElementById('skewness').innerText, 10, 60);
            doc.text('Kurtosis: ' + document.getElementById('kurtosis').innerText, 10, 70);
            doc.text('Cp: ' + document.getElementById('cp').innerText, 10, 80);
            doc.text('Cpk: ' + document.getElementById('cpk').innerText, 10, 90);
            doc.text('DPMO: ' + document.getElementById('dpmo').innerText, 10, 100);
            doc.text('Yield: ' + document.getElementById('yield').innerText, 10, 110);
            doc.text('1 Std Dev: ' + document.getElementById('control_1_stddev').innerText, 10, 120);
            doc.text('2 Std Dev: ' + document.getElementById('control_2_stddev').innerText, 10, 130);
            doc.text('3 Std Dev: ' + document.getElementById('control_3_stddev').innerText, 10, 140);

            const histogramChartCanvas = document.getElementById('histogramChart');
            const histogramChartImg = histogramChartCanvas.toDataURL('image/png');
            doc.addImage(histogramChartImg, 'PNG', 10, 150, 180, 90);

            const controlChartCanvas = document.getElementById('controlChart');
            const controlChartImg = controlChartCanvas.toDataURL('image/png');
            doc.addImage(controlChartImg, 'PNG', 10, 250, 180, 90);

            doc.save('charts.pdf');
        }
    </script>
</body>
</html>